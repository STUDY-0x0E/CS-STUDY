# 교착상태의 이해

## 개요
- 교착상태란?
- 교착상태 발생 원인
- 교착상태 특징
- 교착상태를 다루는 방법
- 교착상태 방지

---

## 교착상태란?

교착상태(Deadlock)이란 어떤 다른 프로세스에 의해 발생된 이벤트에 의해 모든 프로세스가 대기하는 현상.

요청한 자원을 다른 대기중인 쓰레드가 점유하고 있어 자원을 요청한 대기중인 쓰레드(또는 프로세스)는 다시는 쓰레드 상태를 변경할 수 없음.

쓰레드 사이에서 분배되는 자원은 유한하다.

자원의 종류:
- CPU 사이클
- 파일
- 입출력 기기(프린터, 드라이브 등)

쓰레드는 자원이 필요할 때, `자원 요청 → 자원 사용 → 자원 해제`의 순서로 진행된다. 자원 사용시 임계 구역(critical section)에 들어가게 된다.

<details>
  
  <summary>
  임계영역이란?
  </summary>
  둘 이상의 스레드가 동시에 접근해서는 안되는 공유 자원(자료 구조 또는 장치)을 접근하는 코드의 일부를 말한다. 
</details>


## 교착상태 발생 원인

어떤 한 프로세스가 A 자원을 점유한 상태에서 B 자원을 점유하고자 할 때, B 자원을 가지고 있는 프로세스가 A 자원을 점유하고자 할 때 발생한다.

<img width="327" alt="스크린샷 2023-12-20 오전 12 32 35" src="https://github.com/STUDY-0x0E/CS-STUDY/assets/123740296/b67c9e80-bc25-421e-a829-d8606e528119">

## 교착상태 특징

### 교착상태 발생 조건
1. 상호 배제 (Mutial Exclusion): 최소 한 개의 자원이 임계 영역에서 점유된다.
2. 점유와 대기 (Hold and Wait): 어떤 한 쓰레드가 최소 한 개의 자원을 점유하고 다른 쓰레드가 가지고 있는 추가적인 자원을 얻고자 대기한다.
3. 선점 불가 (No preemption): 자원들이 선점이 불가능 할 때이다.
4. 원형 대기 (Circular Wait): 종속적인 대기 그래프가 원형이 존재할때 발생한다.

### 대기 그래프 

트랜젝션 Ti가 필요로 하는 데이터 항목을 트랜젝션 Tj가 놓아주기를 기다리는 것을 Ti → Tj의 방향성 간선으로 표시한다. 만약 대기 그래프에 순환(cycle)이 포함되면 교착상태가 존재한다.

![image](https://github.com/STUDY-0x0E/CS-STUDY/assets/123740296/b0f26ce4-b4a3-4b47-bec5-f43b6d25af76)

### 자원 할당 그래프(Resource-Allocation Graph)

자원 할당 그래프은 교착상태를 더 쉽게 이해하기 위한 방향성 그래프이다.

정점의 두가지 종류:
- T = {T1, T2, ..., Tn): 시스템에서 활성화된 쓰레드의 집합
- R = {R1, R2, ..., Rn): 시스템에서 모든 자원 유형의 집합

방향성 간선 Ti -> Rj (요청 가선): 쓰레드 i가 자원 Rj를 요청

방향성 간선 Rj -> Ti (할당 간선): 자원 Rj가 쓰레드 i에게 할당됨

![image](https://github.com/STUDY-0x0E/CS-STUDY/assets/123740296/a56f1e60-5c73-4c9b-8c09-a83f3f6f7677)
- 쓰레드 1에는 first_mutex lock이 할당되어 있고 second_mutex 자원을 요청하는 상태
- 쓰레드 2에는 second_mutex lock이 할당되어 있고 first_mutex 자원을 요청하는 상태

자원 할당 그래프를 통해 교착상태가 일어날 가능성이 있는지 파악할 수 있다.

**교착상태가 발생하는 자원 할당 그래프**

<img width="528" alt="스크린샷 2023-12-20 오전 1 21 43" src="https://github.com/STUDY-0x0E/CS-STUDY/assets/123740296/222f3b8a-cc1c-4ee5-b2ed-9d199ba63070">

T2가 T3의 자원(R3)을 원하고 T3가 T2의 자원(R2)을 원해 원형대기가 발생해 교착상태가 발생한다.

**교착상태가 발생하지 않는 자원 할당 그래프**
![image](https://github.com/STUDY-0x0E/CS-STUDY/assets/123740296/2da13c2c-4885-46af-83b5-9fbf34899e0d)

T1 → R1 → T3 → T2로 원형이 생성되었지만 R1과 R2 자원 유형은 인스턴스가 각각 2개여서 충분하다.

T2와 T4가 작업을 마치고 R1, R2 자원을 반환하면서 T3, T1도 작업을 마칠 수 있기 때문에 교착상태가 발생하지 않는다.

**자원 할당 그래프로 보는 교착상태**

- 자원 할당 그래프가 원형(Cycle)을 가지고 있지 않다면 교착상태가 확정적으로 발생하지 않는다.
- 자원 할당 그래프가 원형(Cycle)을 가지고 있더라도 교착상태가 무조건적으로 발생하지는 않는다.


## 교착상태를 다루는 방법
1. 문제를 완전히 무시하기:
   - 시스템에서 교착상태가 무조건 발생하지 않는 척 함
3. 교착상태를 방지(prevent)하거나 회피(avoid):
   - 방지: 교착상태로 진입하는 것을 방지함. 그러나 교착상태 방지는 거의 불가능한 방법임.
   - 회피: Banker's Algorithm
4. 교착상태 발생을 허용:
   탐색(Detect)하고 회복(Recover)하는 절차를 수행함.
   - 교착상태 탐색: 교착상태가 발생하는지 탐색하는 연산
   - 교착상태 회복: 교착상태가 발생하기 이전으로 되돌아가는 연산

## 교착상태 방지
교착상태가 발생하는 조건 4자기(상호배제, 점유와 대기, 선점 불가, 원형 대기)중 하나가 발생하는 것을 막는 방법이다.

### 상호 배제를 방지하기
상호 배제의 발생 조건: 최소 한 개의 자원이 임계 영역에서 점유됨. 즉 최소 한 개의 자원이 공유 불가능

이 조건을 방지하기 위해 **모든 자원이 공유**되게 하는 방법이다. 하지만 일반적으로 대부분의 애플리케이션에 적용할 수 없는 방법이다. 
- 몇몇 자원들은 본질적으로 공유가 되면 안되기 때문
- 예) 뮤텍스 락같은 자원의 경우 여러 쓰레드에 의해 공유되면 안되는 자원임

즉 상호배제를 방지하는 방법은 불가능하다.

### 점유와 대기(Hold and Wait)을 방지하는 방법
어떤 한 쓰레드가 자원을 요청시 이미 점유하고 있는 자원을 해제한 후 요청한다.

- 예) 쓰레드가 A라는 자원을 요청시 B라는 자원을 이미 점유중이면, B자원을 해제하고 요청한 A 자원을 얻을 때까지 대기한다. A 자원을 얻은 다음에 이전에 해제한 A 자원을 요청해 자원을 받는다.

이 방법은 대부분의 응용 프로그램에서 비실용적이다.

### 선점 불가(No preemption)를 방지하는 방법
자원을 점유하고 있는 쓰레드에 대해 해당 자원을 선점해 쓰레드가 자원을 내려놓게 한다.

- 예) 쓰레드가 A라는 자원을 가지고 있는 상태에서 B 자원을 요청한다. 다른 쓰레드가 B 자원을 점유하고 있다면 B 자원을 해제시켜 선점한다.

이 방법은 대부분의 응용 프로그램에서 일반적으로 적용할 수 없다.

### 원형 대기(Circular Wait)을 방지하는 방법
모든 자원 유횽들에 순서를 지정한다. 각각 쓰레드가 자원을 오름차순으로 요청하게 한다. 쓰레드는 자신이 점유하고 있는 자원보다 높은 자원들만 요청하게 한다. 

![image](https://github.com/STUDY-0x0E/CS-STUDY/assets/123740296/5c940d6e-41d1-4ca4-8313-0e4b6daf457e)

<img width="691" alt="스크린샷 2023-12-20 오전 3 07 21" src="https://github.com/STUDY-0x0E/CS-STUDY/assets/123740296/39d40587-48f2-4ed2-a436-d693399f9155">


가장 실용적인 방법이지만 기아 발생 가능성이 높아지고 교착상태 방지를 완전히 보장하진 않는다. 

---
참조

- [https://yonghwankim-dev.tistory.com/480](https://yonghwankim-dev.tistory.com/480)
- [https://ko.wikipedia.org/wiki/%EC%9E%84%EA%B3%84_%EA%B5%AC%EC%97%AD](https://ko.wikipedia.org/wiki/%EC%9E%84%EA%B3%84_%EA%B5%AC%EC%97%AD)
- [https://terms.tta.or.kr/dictionary/dictionaryView.do?subject=wait-for%20graph](https://terms.tta.or.kr/dictionary/dictionaryView.do?subject=wait-for%20graph)
- [https://velog.io/@zoowife2/%EC%BB%B4%ED%93%A8%ED%84%B0-%EA%B3%B5%ED%95%99-%EA%B8%B0%EC%B4%88-13-2](https://velog.io/@zoowife2/%EC%BB%B4%ED%93%A8%ED%84%B0-%EA%B3%B5%ED%95%99-%EA%B8%B0%EC%B4%88-13-2)
